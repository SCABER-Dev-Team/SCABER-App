<div class="pass-pages pass-riding" id="pass-riding">
    <div class="pass-map" id="map"></div>
    <div class="pass-toolbar">
        <div class="row">
            <div class="col s6 m6 l6">
                <a class="waves-effect waves-light btn btn-large" href="#modal-succ">預約乘車
                    <i class="material-icons right">event</i>
                </a>
            </div>
            <div class="col s6 m6 l6">
                <a class="waves-effect waves-light btn btn-large" href="#modal-book">立即乘車
                    <i class="material-icons right">local_taxi</i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- modal ordering -->
<div class="modal modal-order" id="modal-order">
    <div class="modal-content">
        <h4>預約 SCABER！</h4>
        <p>按下「預約乘車」我們將儘速爲您派車。</p>
    </div>
    <div class="modal-footer">
        <button class="modal-action waves-effect waves-green btn-flat" onclick="triggerPassengerOrderModal('form');">預約乘車</button>
    </div>
</div>

<!-- modal form -->
<div class="modal modal-form" id="modal-form">
    <div class="modal-content">
        <h4>開始預約！</h4>
        <form class="cpl s12">
            <div class="row modal-input">
                <div class="input-field col s12">
                    <i class="material-icons prefix">account_circle</i>
                    <input id="username" type="text">
                    <label class="center-align" for="username" data-error="wrong" data-success="right">乘車地</label>
                </div>
            </div>
            <div class="row modal-input">
                <div class="input-field col s12">
                    <i class="material-icons prefix">mail</i>
                    <input id="email" type="email">
                    <label class="center-align" for="email" data-error="wrong" data-success="right">目的地</label>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button class="modal-action waves-effect waves-green btn-flat">預約乘車</button>
    </div>
</div>

<!-- modal booking -->
<div class="modal modal-book" id="modal-book">
    <div class="modal-content">
        <h4>立即 SCABER！</h4>
        <p>按下「立即乘車」我們將儘速爲您派車。</p>
    </div>
    <div class="modal-footer">
        <button class="modal-action waves-effect waves-green btn-flat" onclick="goRiding()">立即乘車</button>
    </div>
</div>

<!-- modal waiting -->
<div class="modal modal-wait" id="modal-wait">
    <div class="modal-content">
        <h4>正在派車中！</h4>
        <p>請您耐心等待，我們正在爲您派車。</p>
    </div>
    <div class="modal-footer valign-wrapper">
        <div class="preloader-wrapper right-align small active">
            <div class="spinner-layer">
                <div class="circle-clipper left">
                    <div class="circle"></div>
                </div><div class="gap-patch">
                    <div class="circle"></div>
                </div><div class="circle-clipper right">
                    <div class="circle"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- modal success -->
<div class="modal modal-succ" id="modal-succ">
    <div class="modal-content">
        <h5>SCABER 正在路上！</h5>
        <ul class="collection collection-avatar">
            <li class="collection-item avatar">
                <i class="material-icons circle">perm_identity</i> 
                <p class="title">司機姓名</p>
                <p class="content-p" id="driver-name">[name]</p>
            </li>
            <li class="collection-item avatar">
                <i class="material-icons circle">local_activity</i> 
                <p class="title">車牌號碼</p>
                <p class="content-p" id="driver-license">[license]</p>

            </li>
            <li class="collection-item avatar">
                <i class="material-icons circle">call</i>
                <p class="title">手機號碼</p>
                <p class="content-p" id="driver-phone">[phone]</p>
            </li>
            <li class="collection-item avatar">
                <i class="material-icons circle">local_taxi</i>
                <p class="title">車輛型號</p>
                <p class="content-p" id="driver-model">[model]</p>
            </li>
            <li class="collection-item avatar">
                <i class="material-icons circle">access_alarm</i>
                <p class="title">抵達時間</p>
                <p class="content-p" id="driver-arrival">約 [arrival time] 分鐘</p>
            </li>
        </ul>
    </div>
    <div class="modal-footer">
        <button id="startBtn" class="modal-action modal-close waves-effect waves-green btn-flat">選擇目的地</button>
        <button class="modal-action modal-close waves-effect waves-green btn-flat">關閉視窗</button>
    </div>
</div>

<!-- modal choose location -->
<div class="modal modal-location" id="modal-location">
    <div class="modal-content">
        <h5>請選擇目的地</h5>
        <ul class="collection">
            <!-- 使用 google api 提供的文字欄位，提供使用者做輸入，並再最後轉換成{lat,lng}的型式做輸出 -->
        </ul>
    </div>
    <div class="modal-footer">
        <button id="tripBtn" class="modal-action modal-close waves-effect waves-green btn-flat">發車！</button>
    </div>
</div>

<!-- Google Map -->
<script>
var map;
var marker;
var infoWindow;
function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 8,
        center: { 
            lat: 25.040606, 
            lng: 121.536547 
        }
    });
    // infowindow
    infoWindow = new google.maps.InfoWindow({content: "SCABER"});
    // Custom marker
    var scaber_flag = {
        url: 'scaber_flag.png',
        size: new google.maps.Size(20,32),
        origin: new google.maps.Point(0,0),
        anchor: new google.maps.Point(0,32)
    };
    // shape of click 
    var scaber_flag_shape = {
        coords: [1,1,1,20,18,20,18,1],
        type: 'poly'
    };
    // marker init 
    marker = new google.maps.Marker({
        position: {lat: 25.040606,lng: 121.536547 },
        map: map,
        icon: scaber_flag,
        shape:scaber_flag_shape,
        title: "Your Position",
        zIndex: 1
    });
    // Add Marker Listen
    marker.addListener('click',function(){
        infoWindow.open(map,marker);
    });
}

const socket = io();

// Notify server to find a driver
function goRiding(){
    if(!passenger_page_status){
        // get current location
        getCurrentLocation(function(err,data){
            if(err){
                console.log(data);
            }
            else{
                // set center 
                map.setZoom(14);
                map.setCenter(data);
                marker.setPosition(data);
                // Call waiting
                $(".modal-book").modal('close');
                triggerPassengerBookModal("waiting");
                // emit signal 
                socket.emit('find_driver',{
                    id: <%- JSON.stringify(scaber_account) %>,
                    phone: <%- JSON.stringify(user_phone) %>,
                    unique: <%- JSON.stringify(passenger_profile.trueID) %>,
                    pos: data
                });
            }
        });
    }
    else{
        $('.modal-book').modal('close');
        $('.modal-succ').modal('open');
    }
}

// driver arrived
function driver_arrived(){
    // Open succ modal
    $('#modal-succ').modal('open');
    // Display start btn 
    $('#startBtn').show();
    // FIXME: notify server to add those GAs into channel
}

// BTN signal here 
$('#startBtn').click(function(){
    // display "location" modal
    $('#modal-location').modal('open');
});

$('#tripBtn').click(function(){
    // FIXME: 判斷使用者是否輸入正確的地標，再做 emit

    // Emit signal to server , broadcast information to each GAs => time to go 
    socket.emit('trip_start',{
        id: <%- JSON.stringify(scaber_account) %>,
        phone: <%- JSON.stringify(user_phone) %>,
        unique: <%- JSON.stringify(passenger_profile.trueID) %>,
        startPos: { lat: 20, lng: 120 },
        endPos: { lat: 20.10, lng: 120.20}
    });
});

// Socket IO section 
socket.on('find_driver_listen',function(rawdata){
    if(rawdata.header == "error"){
        triggerPassengerBookModal("waiting");
    }
    else{
        triggerPassengerBookModal("match");
        // set driver info 
        $('#driver-name').html(rawdata.msg.driverName);
        $('#driver-phone').html(rawdata.msg.driverPhone);
        $('#driver-license').html(rawdata.msg.license);
        $('#driver-model').html(rawdata.msg.car_model);
        // Start timer 
        arrivalTimer("2:30");
    }
});
</script>

<!-- Google Map API -->
<script src="https://maps.googleapis.com/maps/api/js??sensor=false&libraries=places&callback=initMap"></script>